<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.renren.modules.ltt.dao.CdLineRegisterDao">

	<!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="io.renren.modules.ltt.entity.CdLineRegisterEntity" id="cdLineRegisterMap">
        <result property="id" column="id"/>
        <result property="ab" column="ab"/>
        <result property="appVersion" column="app_version"/>
        <result property="countryCode" column="country_code"/>
        <result property="phone" column="phone"/>
        <result property="proxy" column="proxy"/>
        <result property="proxyStatus" column="proxy_status"/>
        <result property="txtToken" column="txt_token"/>
        <result property="taskId" column="task_id"/>
        <result property="smsCode" column="sms_code"/>
        <result property="registerStatus" column="register_status"/>
        <result property="deleteFlag" column="delete_flag"/>
        <result property="createTime" column="create_time"/>
        <result property="token" column="token"/>
        <result property="getPhoneId" column="get_phone_id"/>
        <result property="pkey" column="pkey"/>
        <result property="subtasksId" column="subtasks_id"/>
        <result property="groupTaskId" column="group_task_id"/>
        <result property="openStatus" column="open_status"/>
        <result property="accountStatus" column="account_status"/>
        <result property="groupCount" column="group_count"/>
        <result property="accountExistStatus" column="account_exist_status"/>
        <result property="errMsg" column="err_msg"/>
        <result property="exportStatus" column="export_status"/>
    </resultMap>

    <select id="getCountBySubTaskId" resultType="io.renren.modules.ltt.vo.GetCountBySubTaskIdVO">
        SELECT
            lr.subtasks_id AS subtasksId,
            COUNT(lr.subtasks_id) totalCount,
            SUM(IF( lr.register_status IN(3,4), 1, 0 )) AS successCount,
            SUM(IF( lr.register_status = 4, 1, 0 )) AS registerSuccessCount,
            SUM(IF( lr.register_status = 5, 1, 0 )) AS errorCount
        FROM
            cd_line_register lr
        WHERE
            lr.subtasks_id > 0 AND
        subtasks_id IN
        <foreach item="item" index="index" collection="registerSubtasksIds" open="(" separator="," close=")">
            #{item}
        </foreach>
        GROUP BY
            lr.subtasks_id
    </select>

    <select id="listPage" resultType="io.renren.modules.ltt.vo.CdLineRegisterVO">

        SELECT
        r.id as id,
        r.ab as ab,
        r.app_version as appVersion,
        r.country_code as countryCode,
        r.phone as phone,
        r.token as token,
        r.proxy as proxy,
        r.txt_token as txtToken,
        r.task_id as taskId,
        r.sms_code as smsCode,
        r.err_msg as errMsg,
        r.register_status as registerStatus,
        r.delete_flag as deleteFlag,
        r.create_time as createTime,
        r.get_phone_id as getPhoneId
        FROM
        cd_line_register r
        LEFT JOIN cd_register_subtasks s ON r.subtasks_id = s.id
        LEFT JOIN cd_register_task t ON s.task_id = t.id
        <where>
            <if test="dto.tasksId != null">
                AND t.id = #{dto.tasksId}
            </if>
            <if test="dto.registerStatus != null">
                AND r.register_status = #{dto.registerStatus}
            </if>
        </where>
        order by r.id desc
    </select>


</mapper>
